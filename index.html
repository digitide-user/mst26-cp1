<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>MST26 CP1</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif; margin: 0; background:#f5f5f5; }
    header { background:#111827; color:#fff; padding:16px; }
    header h1 { margin:0; font-size:20px; }
    main { padding: 16px; max-width: 720px; margin: 0 auto; }
    .card { background:#fff; border-radius:14px; padding:14px; margin:12px 0; box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    input, button { font-size:18px; padding:12px; border-radius:12px; }
    input { border:1px solid #d1d5db; flex: 1; min-width: 220px; }
    button { border:0; background:#2563eb; color:#fff; font-weight:700; }
    button.secondary { background:#374151; }
    button.danger { background:#b91c1c; }
    .status { font-size:14px; color:#374151; line-height: 1.5; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    ul { padding-left: 18px; margin: 8px 0 0; }
    li { margin: 6px 0; }
    /* Camera preview: square (width = height) */
    #camVideo { width: 100%; aspect-ratio: 1 / 1; height: auto !important; max-height: none !important; object-fit: cover; background: #000; border-radius: 18px; display: block; }
    /* canvasは解析用なので表示しない（レイアウト崩れ防止） */
    #camCanvas { display: none; }

    /* details の summary をボタン風に */
    details > summary {
      display: inline-block;
      padding: 10px 14px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
    }
    /* marker を消す（Safari含む） */
    details > summary::-webkit-details-marker { display: none; }
    details > summary::marker { content: ""; }
    details[open] > summary { background: #e5e7eb; }

    /* カメラのステータス表示は視認性UP */
    #camStatus {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.6;
      letter-spacing: 0.01em;
    }
  </style>
</head>
<body>
  <header>
    <h1>MST26 CP1（オフライン対応）</h1>
  </header>

  <main>
    <div class="card">
      <details>
        <summary style="cursor:pointer; font-weight:600;">詳細</summary>
        <div style="margin-top:10px;">
          <div class="status" id="netStatus">状態: 読み込み中…</div>
          <div class="status">API: <span class="mono" id="apiBase">(未設定)</span></div>
          <div class="status">端末ID: <span class="mono" id="deviceId">(未設定)</span> / operator: <span class="mono" id="operator">(未設定)</span></div>
          <div id="lastSyncErrorRow" class="status" style="display:none;">
            <span class="kv-label">同期エラー:</span>
            <span id="lastSyncError" class="kv-value mono"></span>
          </div>
        </div>
      </details>
    </div>

    <!-- 1) カメラ -->
    <div class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">カメラでQR読み取り</h2>

      <div class="row">
        <button class="secondary" id="camStartBtn">カメラ開始</button>
        <button class="secondary" id="camStopBtn" disabled>停止</button>
      </div>

      <div class="status" id="camStatus" style="margin-top:8px;">未開始</div>

      <div style="margin-top:10px; position:relative; border-radius:14px; overflow:hidden; background:#000;">
        <video
          id="camVideo"
          playsinline
          muted
          style="width:100%; height:auto; display:block;"
        ></video>
        <!-- 目印（枠） -->
        <div style="
          position:absolute; inset:0;
          display:flex; align-items:center; justify-content:center;
          pointer-events:none;
        ">
          <div style="
            width:70%; max-width:380px; aspect-ratio:1/1;
            border:3px solid rgba(255,255,255,.85);
            border-radius:16px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,.25) inset;
          "></div>
        </div>
      </div>

      <!-- 解析用（非表示）：必要なら app.js で使う -->
      <canvas id="camCanvas" style="display:none;"></canvas>
    </div>


    <!-- 2) 未送信キュー -->
    <div class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">未送信キュー</h2>
      <div class="row">
        <button class="secondary" id="syncBtn">同期送信</button>
        <button class="danger" id="clearBtn">全消去</button>
      </div>
      <div class="status" id="syncResult"></div>
      <div class="status">未送信: <b id="pendingCount">0</b></div>
      <ul id="pendingList"></ul>
    </div>

    <!-- 3) 手入力（非常用） -->
    <div class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">手入力でキュー追加（非常用）</h2>
      <div class="row">
        <input id="qrInput" placeholder="例: MST26:021  または  21" />
        <button id="addBtn">追加</button>
      </div>
      <div class="status" id="addResult"></div>
    </div>

    <!-- 4) 名簿 -->
    <div class="card">
      <h2 style="margin:0 0 10px;font-size:18px;">名簿（/roster）</h2>
      <div class="row">
        <button class="secondary" id="rosterBtn">名簿更新</button>
      </div>
      <div class="status" id="rosterResult"></div>
    </div>

    <div class="card">
      <div class="status">
        ※最初にオンラインで1回開くと、Service Worker がファイルをキャッシュします（次ステップで有効化）。<br/>
        ※fetchは Content-Type を付けない方針です（プリフライト回避）。<br/>
      </div>
    </div>
  </main>

  <script>
    // Service Worker（次のステップで sw.js を追加したら有効化される）
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js?v=20260226-1").catch(() => {});
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="./app.js?v=20260226-1"></script>
</body>
</html>
